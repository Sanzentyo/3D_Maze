# 3D Maze 詳細設計書

## 1. 概要
本ドキュメントでは、3D Maze プロジェクトの内部構造について、クラス・メソッド・変数を中心に整理した詳細設計を示します。  
主に以下の機能を提供しており、Pyxel 上で 3D 表示を簡易的に実装する仕組みをクラス単位で定義しています。  

## 2. プログラム全体構造
アプリケーションは大きく `StartScene`, `GameScene`, `ScoreScene` の 3 つのシーンに分かれ、それぞれで画面や情報を管理します。  
最初に `App` クラスが Pyxel の初期化とメインループを制御し、現在のシーンの更新・描画処理を行います。

## 3. 重要な処理フロー
### 3.1 ゲームループ
1. `App.update()` がフレームごとに呼び出され、現在のシーンの `update()` を実行  
2. `App.draw()` がフレームごとに呼び出され、現在のシーンの `draw()` を実行  

### 3.2 3D 描画フロー
1. `GameScene.draw_3d()` からカメラ行列取得 (`Camera.get_view_projection_matrix()`)  
2. `Maze` や `Cube`, `Sphere` 等の 3D オブジェクトを `TriSprite` で描画用三角形に変換  
3. `TriSprite.clip_triangle()` で 3D→2D の投影計算  
4. `TriSprite.draw()` で Pyxel 上に描画  

### 3.3 プレイヤー移動フロー
1. `GameScene.update()` 内でプレイヤー (`Player`) の位置と回転を更新  
2. 移動・回転は `Player.move()`/`rotate()` で行い、`Maze.collide()` を用いて壁に衝突しないように補正  

## 4. クラス一覧

### 4.1 `App` (メインアプリケーションクラス)
- 役割: Pyxel アプリケーション全体の初期化・ループ管理  
- 主な変数:  
  - `scene`: 現在のシーン (`StartScene`, `GameScene`, `ScoreScene`)  
- 主なメソッド:  
  - `__init__()`: Pyxel の初期化と最初のシーン設定  
  - `update()`: 毎フレーム呼ばれる更新処理。現在のシーンの `update()` を呼び出す  
  - `draw()`: 毎フレーム呼ばれる描画処理。現在のシーンの `draw()` を呼び出す  

### 4.2 `StartScene` (スタート画面クラス)
- 役割: タイトルや操作説明など、ゲーム開始前の画面を管理  
- 主なメソッド:  
  - `update()`: ユーザーの入力を検知し、ゲーム開始のタイミングを判定  
  - `draw()`: タイトルや操作説明の描画  

### 4.3 `GameScene` (ゲームシーン)
- 役割: プレイヤーや迷路、敵などゲームプレイ中の要素を管理  
- 主な変数:  
  - `player`: プレイヤー (`Player`)  
  - `maze`: 迷路 (`Maze`)  
  - `camera`: カメラ (`Camera`)  
- 主なメソッド:  
  - `__init__()`: プレイヤーや迷路、カメラなどゲーム内要素の初期化  
  - `update()`: プレイヤーや迷路状態の更新・衝突処理・ゲーム進行管理  
  - `draw()`: 3D描画 (`draw_3d`) と 2D描画 (`draw_2d`) の実行  
  - `draw_3d()`: 3D オブジェクトの描画  
  - `draw_2d()`: UI やテキストなど 2D 要素の描画  

### 4.4 `ScoreScene` (スコア画面クラス)
- 役割: ゲーム終了後のリザルトやスコアを表示  
- 主なメソッド:  
  - `update()`: リトライや終了などの選択入力受付  
  - `draw()`: スコアやメッセージの描画  

### 4.5 `Player` (プレイヤークラス)
- 役割: プレイヤーの位置、回転、操作処理を担当  
- 主な変数:  
  - `position`: (x, y, z) の座標  
  - `rotation`: (yaw, pitch) など回転角度  
- 主なメソッド:  
  - `update()`: 入力検知と移動/回転の実行  
  - `move()`: 位置更新  
  - `rotate()`: 回転更新  

### 4.6 `Map` (マップクラス)
- 役割: 迷路の構造管理と衝突判定  
- 主な変数:  
  - `grid`: 迷路のセル情報を保持する配列  
  - `width`, `height`: 迷路の幅・高さ  
- 主なメソッド:  
  - `__init__()`: 迷路データの初期化  
  - `draw()`: 迷路を構成する壁やアイテムを描画  
  - `collide()`: 指定座標が壁や障害物に衝突するか判定  
  - `get_cell()`: グリッド内のセル情報を取得  

### 4.7 `Camera` (カメラクラス)
- 役割: 3D シーンを描画するための視点と投影の管理  
- 主な変数:  
  - `position`: カメラの位置 (x, y, z)  
  - `target`: 注視点 (x, y, z)  
- 主なメソッド:  
  - `get_view_matrix()`: ビュー行列の計算  
  - `get_projection_matrix()`: 投影行列の計算  
  - `get_view_projection_matrix()`: ビュー投影行列 (VP行列) の取得  

### 4.8 `TriSprite` (3D 三角形スプライトクラス)
- 役割: 3D 空間の三角形を 2D 表示に投影し、描画する補助クラス  
- 主な変数:  
  - `p1`, `p2`, `p3`: 三角形の頂点座標  
  - `color`: Pyxel で描画する際の色情報  
- 主なメソッド:  
  - `clip_triangle()`: 3D→2D 変換用クリッピング  
  - `draw()`: 変換後の三角形を Pyxel の画面に描画  

### 4.9 `Cube` (立方体クラス)
- 役割: 立方体形状の 3D オブジェクトを提供  
- 主なメソッド:  
  - (例) `draw()`: `TriSprite` を使って各面を描画  

### 4.10 `RotatingCube` (回転する立方体クラス)
- 役割: `Cube` を継承し、回転機能を付与  
- 主なメソッド:  
  - `update()`: 回転処理  

### 4.11 `Sphere` (球体クラス)
- 役割: 球体形状の 3D オブジェクトを提供  
- 主なメソッド:  
  - `draw()`: `TriSprite` を使って球体を擬似的に描画  

### 4.12 `DrawObject` (3D 描画オブジェクト基底クラス)
- 役割: 3D 描画オブジェクトの共通処理を提供  
- 主なメソッド:  
  - `draw()`: 派生クラスでオーバーライドして描画  

### 4.13 `MazeGenerator` (迷路生成クラス)
- 役割: 開始位置やゴール位置を含む迷路をランダムに生成  
- 主なメソッド:  
  - `generate()`: 迷路データを生成し、`Maze` にセット  
  - `_place_start_end()`: スタート・ゴール位置を設定